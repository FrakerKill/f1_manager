{% extends "base.html" %}

{% block title %}Carrera en Directo{% endblock %}

{% block content %}
<h1>Carrera en Directo - {{ race.circuit.name }}</h1>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Eventos en Directo</h5>
            </div>
            <div class="card-body" style="height: 400px; overflow-y: auto;" id="live-events">
                <div class="text-center" id="loading-events">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p>Cargando eventos en directo...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Información de la Carrera</h5>
            </div>
            <div class="card-body">
                <p><strong>Circuito:</strong> {{ race.circuit.name }}</p>
                <p><strong>Vueltas:</strong> {{ race.laps }}</p>
                <p><strong>País:</strong> {{ race.circuit.country }}</p>
            </div>
        </div>
    </div>
</div>

<script>
function loadLiveEvents() {
    fetch(`/api/live_events/{{ race.id }}`)
        .then(response => response.json())
        .then(events => {
            const eventsContainer = document.getElementById('live-events');
            const loadingElement = document.getElementById('loading-events');
            
            if (loadingElement) {
                loadingElement.remove();
            }
            
            eventsContainer.innerHTML = '';
            
            events.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = `alert ${getEventClass(event.type)}`;
                eventElement.innerHTML = `
                    <strong>Vuelta ${event.lap}:</strong> ${event.description}
                `;
                eventsContainer.prepend(eventElement);
            });
        });
}

function getEventClass(eventType) {
    const classes = {
        'overtake': 'alert-success',
        'pit_stop': 'alert-info',
        'spin': 'alert-warning',
        'fast_lap': 'alert-primary',
        'dnf': 'alert-danger'
    };
    return classes[eventType] || 'alert-secondary';
}

// Cargar eventos cada 5 segundos
setInterval(loadLiveEvents, 5000);
loadLiveEvents();
</script>
{% endblock %}