{% extends "base.html" %}

{% block title %}Sesi√≥n de Tests{% endblock %}

{% block content %}
<h1>Sesi√≥n de Tests - {{ race.circuit.name }}</h1>

<div class="row">
    <div class="col-md-8">
        <!-- Informaci√≥n Meteorol√≥gica -->
        <div class="card mb-4">
            <div class="card-header">
                <h5>üå§Ô∏è Condiciones Meteorol√≥gicas</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Pron√≥stico para Tests:</strong></p>
                        {% set test_weather = weather_forecasts|selectattr("session_type", "equalto", "test")|first %}
                        {% if test_weather %}
                        <div class="weather-condition">
                            <span class="badge bg-{% if test_weather.condition == 'dry' %}warning{% elif test_weather.condition == 'light_rain' %}info{% else %}primary{% endif %}">
                                {% if test_weather.condition == 'dry' %}üå§Ô∏è Seco
                                {% elif test_weather.condition == 'light_rain' %}üåßÔ∏è Lluvia Ligera
                                {% else %}‚õàÔ∏è Lluvia Intensa{% endif %}
                            </span>
                            <small class="text-muted">Probabilidad: {{ (test_weather.probability * 100)|int }}%</small>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <small>No hay pron√≥stico disponible para tests</small>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <p><strong>Recomendaci√≥n de Neum√°ticos:</strong></p>
                        <div id="tyreRecommendation">
                            {% if test_weather %}
                                {% if test_weather.condition == 'dry' %}
                                <span class="badge bg-success">Usar Secos: Soft/Medium/Hard</span>
                                {% elif test_weather.condition == 'light_rain' %}
                                <span class="badge bg-info">Usar Lluvia (Wet)</span>
                                {% else %}
                                <span class="badge bg-primary">Usar Lluvia Extrema</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary">Condiciones no disponibles</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>Configuraci√≥n del Test</h5>
            </div>
            <div class="card-body">
                <!-- Contador de Tests Activos -->
                <div id="testCounter" class="alert alert-info mt-3" style="display: none;">
                    <!-- Se llenar√° din√°micamente con JavaScript -->
                </div>

                <form id="testConfigForm">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Seleccionar Piloto</label>
                            <select class="form-select" id="driverSelect" required>
                                <option value="">Selecciona un piloto</option>
                                {% for driver in team.drivers %}
                                <option value="{{ driver.id }}" data-skill="{{ driver.skill }}" data-consistency="{{ driver.consistency }}">
                                    {{ driver.name }} (Habilidad: {{ driver.skill }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Neum√°tico</label>
                            <select class="form-select" id="tyreSelect" required>
                                <option value="soft">Blando (Soft) - Mejor en seco</option>
                                <option value="medium">Medio (Medium) - Equilibrado</option>
                                <option value="hard">Duro (Hard) - Duradero</option>
                                <option value="wet">Lluvia (Wet) - Lluvia ligera</option>
                                <option value="extreme_wet">Lluvia Extrema - Lluvia intensa</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Vueltas a realizar</label>
                        <input type="number" class="form-control" id="totalLaps" value="20" min="5" max="50" required>
                        <div class="form-text">M√°ximo 50 vueltas por sesi√≥n de test</div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="startTestBtn">
                        <i class="fas fa-play-circle me-1"></i>Iniciar Sesi√≥n de Test
                    </button>
                </form>
            </div>
        </div>

        <div class="card mt-4" id="testResults" style="display: none;">
            <div class="card-header">
                <h5>Resultados del Test</h5>
            </div>
            <div class="card-body">
                <div id="testProgress" class="mb-3">
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             id="testProgressBar" style="width: 0%">0%</div>
                    </div>
                </div>
                
                <div id="lapResults" style="max-height: 400px; overflow-y: auto;">
                    <!-- Los resultados de las vueltas aparecer√°n aqu√≠ -->
                </div>
                
                <div class="mt-3" id="testSummary" style="display: none;">
                    <h6>Resumen del Test</h6>
                    <div id="summaryContent"></div>
                    <div class="mt-3">
                        <a href="{{ url_for('race_strategy', race_id=race.id) }}" class="btn btn-success">
                            <i class="fas fa-flag me-1"></i>Ir a Planificar Estrategia de Carrera
                        </a>
                        <button class="btn btn-outline-primary" onclick="location.reload()">
                            <i class="fas fa-redo me-1"></i>Hacer Otro Test
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Clasificaci√≥n General de Tests - VERSI√ìN BASE DE DATOS -->
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üèÅ Clasificaci√≥n General de Tests</h5>
                <button class="btn btn-sm btn-outline-secondary" id="refreshLeaderboardBtn">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="testLeaderboard">
                        <thead>
                            <tr>
                                <th width="80" class="text-center">Posici√≥n</th>
                                <th>Piloto</th>
                                <th width="120" class="text-center">Equipo</th>
                                <th width="120" class="text-center">Mejor Vuelta</th>
                                <th width="100" class="text-center">Vueltas</th>
                                <th width="100" class="text-center">Tests</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboardBody">
                            <!-- Los datos se cargar√°n desde la base de datos -->
                        </tbody>
                    </table>
                </div>

                <!-- Mensaje cuando no hay datos -->
                <div id="noTestsMessage" class="text-center text-muted p-3">
                    <p>No hay tests registrados todav√≠a.</p>
                    <small>Realiza tu primer test para ver la clasificaci√≥n.</small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Informaci√≥n de Neum√°ticos</h5>
            </div>
            <div class="card-body">
                <div class="tyre-info mb-3 p-3 border rounded">
                    <h6>Blandos (Soft)</h6>
                    <small class="text-muted">
                        <strong>Seco:</strong> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê<br>
                        <strong>Lluvia:</strong> ‚≠ê‚≠ê<br>
                        <strong>Durabilidad:</strong> ‚≠ê‚≠ê<br>
                        <strong>Ideal:</strong> 10-20 vueltas secas
                    </small>
                </div>
                <div class="tyre-info mb-3 p-3 border rounded">
                    <h6>Medios (Medium)</h6>
                    <small class="text-muted">
                        <strong>Seco:</strong> ‚≠ê‚≠ê‚≠ê‚≠ê<br>
                        <strong>Lluvia:</strong> ‚≠ê<br>
                        <strong>Durabilidad:</strong> ‚≠ê‚≠ê‚≠ê<br>
                        <strong>Ideal:</strong> 20-40 vueltas secas
                    </small>
                </div>
                <div class="tyre-info mb-3 p-3 border rounded">
                    <h6>Duros (Hard)</h6>
                    <small class="text-muted">
                        <strong>Seco:</strong> ‚≠ê‚≠ê‚≠ê<br>
                        <strong>Lluvia:</strong> ‚≠ê<br>
                        <strong>Durabilidad:</strong> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê<br>
                        <strong>Ideal:</strong> 40-60 vueltas secas
                    </small>
                </div>
                <div class="tyre-info mb-3 p-3 border rounded">
                    <h6>Lluvia (Wet)</h6>
                    <small class="text-muted">
                        <strong>Seco:</strong> ‚≠ê‚≠ê<br>
                        <strong>Lluvia:</strong> ‚≠ê‚≠ê‚≠ê‚≠ê<br>
                        <strong>Durabilidad:</strong> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê<br>
                        <strong>Ideal:</strong> Lluvia ligera
                    </small>
                </div>
                <div class="tyre-info mb-3 p-3 border rounded">
                    <h6>Lluvia Extrema</h6>
                    <small class="text-muted">
                        <strong>Seco:</strong> ‚≠ê<br>
                        <strong>Lluvia:</strong> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê<br>
                        <strong>Durabilidad:</strong> ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê<br>
                        <strong>Ideal:</strong> Lluvia intensa
                    </small>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Historial de Tests - Mi Equipo</h5>
                <button class="btn btn-sm btn-outline-info" id="clearHistoryBtn">
                    <i class="fas fa-info-circle me-1"></i>Informaci√≥n de Tests
                </button>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <select class="form-select form-select-sm" id="historyFilter">
                        <option value="all">Todos los tests</option>
                        <option value="today">Hoy</option>
                        <option value="week">Esta semana</option>
                    </select>
                </div>
                <div id="testHistory" style="max-height: 400px; overflow-y: auto;">
                    <!-- Los tests se cargar√°n desde la base de datos -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Incluir el motor de simulaci√≥n -->
<script src="{{ url_for('static', filename='js/race_engine.js') }}"></script>

<script>
// DEBUG: Funci√≥n para verificar el localStorage (mantener para compatibilidad)
function debugLocalStorage() {
    console.log("=== DEBUG LOCALSTORAGE ===");
    const allTests = JSON.parse(localStorage.getItem('testHistory')) || [];
    console.log("Total tests en localStorage:", allTests.length);
    console.log("===========================");
}

// Funci√≥n para normalizar nombres de pilotos
function normalizeDriverName(name) {
    return name.replace(/\s+/g, ' ').trim();
}

// Funciones globales auxiliares
function getTyreColor(tyreType) {
    const colors = { 
        'soft': 'danger', 'medium': 'warning', 'hard': 'secondary',
        'wet': 'info', 'extreme_wet': 'primary'
    };
    return colors[tyreType] || 'primary';
}

function getTyreName(tyreType) {
    const names = { 
        'soft': 'Blando', 'medium': 'Medio', 'hard': 'Duro',
        'wet': 'Lluvia', 'extreme_wet': 'Lluvia Extrema'
    };
    return names[tyreType] || tyreType;
}

function getConditionName(condition) {
    const names = { 
        'dry': 'üå§Ô∏è Seco', 
        'light_rain': 'üåßÔ∏è Lluvia Ligera', 
        'heavy_rain': '‚õàÔ∏è Lluvia Intensa' 
    };
    return names[condition] || condition;
}

function getConditionColor(condition) {
    const colors = { 
        'dry': 'warning', 
        'light_rain': 'info', 
        'heavy_rain': 'primary' 
    };
    return colors[condition] || 'secondary';
}

function getTemperatureColor(temperature, condition) {
    if (condition === 'cold') return 'info';
    if (condition === 'optimal') return 'success';
    if (condition === 'warming') return 'warning';
    if (condition === 'overheating') return 'danger';
    return 'secondary';
}

// FUNCI√ìN PARA MOSTRAR INFORMACI√ìN SOBRE L√çMITES DE TESTS
function showTestLimitsInfo() {
    alert('üìã Sistema de Tests Autom√°tico\n\n' +
          '‚Ä¢ L√≠mite m√°ximo: 5 tests activos por equipo\n' +
          '‚Ä¢ No se pueden eliminar manualmente\n' +
          '‚Ä¢ Se eliminan autom√°ticamente despu√©s de cada carrera\n' +
          '‚Ä¢ Los tests antiguos se limpian cada 6 horas\n\n' +
          'üí° Consejo: Realiza tests estrat√©gicos para cada carrera');
}

// FUNCI√ìN PARA VERIFICAR EL L√çMITE DE TESTS
async function checkTestLimit() {
    try {
        const response = await fetch('/api/tests/my_team/count');
        const limitInfo = await response.json();
        
        if (limitInfo.count >= 5) {
            return {
                allowed: false,
                count: limitInfo.count,
                remaining: limitInfo.remaining,
                message: `Has alcanzado el l√≠mite m√°ximo de 5 tests activos. Los tests se eliminar√°n autom√°ticamente despu√©s de cada carrera.`
            };
        }
        
        return {
            allowed: true,
            count: limitInfo.count,
            remaining: limitInfo.remaining,
            message: `Tests activos: ${limitInfo.count}/5 (${limitInfo.remaining} restantes)`
        };
    } catch (error) {
        console.error('Error verificando l√≠mite de tests:', error);
        return {
            allowed: true, // Permitir en caso de error
            count: 0,
            remaining: 5,
            message: 'No se pudo verificar el l√≠mite de tests'
        };
    }
}

// FUNCI√ìN PARA MOSTRAR CONTADOR DE TESTS
async function updateTestCounter() {
    try {
        const response = await fetch('/api/tests/my_team/count');
        const limitInfo = await response.json();
        
        // Crear o actualizar el contador en la interfaz
        let counterElement = document.getElementById('testCounter');
        if (!counterElement) {
            counterElement = document.createElement('div');
            counterElement.id = 'testCounter';
            counterElement.className = 'alert alert-info mt-3';
            document.querySelector('.card-body').prepend(counterElement);
        }
        
        const remaining = limitInfo.remaining;
        const isAtLimit = remaining <= 0;
        
        counterElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <span>
                    <strong>Tests activos:</strong> ${limitInfo.count}/5 
                    ${isAtLimit ? ' (L√≠mite alcanzado)' : ` (${remaining} restantes)`}
                </span>
                ${isAtLimit ? '<span class="badge bg-danger">L√≠mite alcanzado</span>' : ''}
            </div>
            <small class="text-muted">
                Los tests se eliminan autom√°ticamente despu√©s de cada carrera
            </small>
            ${isAtLimit ? `
            <div class="mt-2">
                <button class="btn btn-sm btn-warning" onclick="showTestLimitsInfo()">
                    <i class="fas fa-info-circle me-1"></i>M√°s informaci√≥n
                </button>
            </div>
            ` : ''}
        `;
        
        // A√±adir clase de advertencia si est√° en el l√≠mite
        if (isAtLimit) {
            counterElement.classList.remove('alert-info');
            counterElement.classList.add('alert-warning');
        } else {
            counterElement.classList.remove('alert-warning');
            counterElement.classList.add('alert-info');
        }
        
        counterElement.style.display = 'block';
        
        // Deshabilitar el bot√≥n de inicio si se alcanz√≥ el l√≠mite
        const startButton = document.getElementById('startTestBtn');
        if (startButton) {
            startButton.disabled = isAtLimit;
            if (isAtLimit) {
                startButton.title = 'L√≠mite de tests alcanzado. Espera a que terminen las carreras para liberar espacio.';
            } else {
                startButton.title = '';
            }
        }
        
        return limitInfo;
    } catch (error) {
        console.error('Error actualizando contador:', error);
        return {
            allowed: true,
            count: 0,
            remaining: 5
        };
    }
}

// FUNCI√ìN PARA MOSTRAR RESUMEN DEL TEST
function showTestSummary(testSummary) {
    const summaryContent = document.getElementById('summaryContent');
    const bestLap = Math.min(...testSummary.lapTimes);
    const avgLap = testSummary.lapTimes.reduce((a, b) => a + b, 0) / testSummary.lapTimes.length;
    
    summaryContent.innerHTML = `
        <div class="alert alert-success">
            <h6>‚úÖ Test Completado Exitosamente</h6>
            <p><strong>Piloto:</strong> ${testSummary.driverName}</p>
            <p><strong>Mejor vuelta:</strong> ${bestLap.toFixed(3)}s</p>
            <p><strong>Vuelta promedio:</strong> ${avgLap.toFixed(3)}s</p>
            <p><strong>Incidentes:</strong> ${testSummary.incidents}</p>
            <p><strong>Paradas en boxes:</strong> ${testSummary.pitStops}</p>
            <p><strong>Tiempo perdido:</strong> ${testSummary.totalTimeLost.toFixed(1)}s</p>
        </div>
        <div class="mt-3">
            <button class="btn btn-sm btn-outline-info" onclick="showWearChart()">
                <i class="fas fa-chart-line me-1"></i>Ver Gr√°fico de Desgaste
            </button>
        </div>
    `;
    
    document.getElementById('testSummary').style.display = 'block';
    
    // Guardar en base de datos
    saveTestToDatabase(testSummary);
}

// FUNCI√ìN PARA GUARDAR EN BASE DE DATOS
async function saveTestToDatabase(testSummary) {
    try {
        const response = await fetch('/api/simulate_test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                driver_id: testSummary.driverId,
                tyre_type: testSummary.initialTyre,
                total_laps: testSummary.totalLaps,
                track_condition: testSummary.trackCondition,
                race_id: {{ race.id }},
                test_results: testSummary.wearData
            })
        });

        const result = await response.json();
        
        if (result.success) {
            console.log('Test guardado en base de datos con ID:', result.test_id);
            // Recargar las tablas despu√©s de guardar
            loadTestLeaderboard();
            loadMyTeamTests();
            updateTestCounter(); // Actualizar contador
            return true;
        } else {
            console.error('Error al guardar test:', result.message);
            alert('Error al guardar test: ' + result.message);
            return false;
        }
    } catch (error) {
        console.error('Error de conexi√≥n:', error);
        alert('Error de conexi√≥n al guardar test');
        return false;
    }
}

// FUNCI√ìN MEJORADA PARA CARGAR CLASIFICACI√ìN DESDE BASE DE DATOS
async function loadTestLeaderboard() {
    const leaderboardBody = document.getElementById('leaderboardBody');
    const noTestsMessage = document.getElementById('noTestsMessage');

    try {
        const response = await fetch('/api/tests/leaderboard');
        const leaderboardData = await response.json();

        if (leaderboardData.length === 0) {
            leaderboardBody.innerHTML = '';
            noTestsMessage.style.display = 'block';
            return;
        }

        noTestsMessage.style.display = 'none';

        let leaderboardHTML = '';
        leaderboardData.forEach((pilot, index) => {
            const position = index + 1;
            const isMyTeam = pilot.is_my_team;
            const teamBadge = isMyTeam ? '<span class="badge bg-primary ms-1">Mi Equipo</span>' : '';
            
            leaderboardHTML += `
                <tr>
                    <td class="text-center">
                        <strong>${position}</strong>
                        ${position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : ''}
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="driver-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" 
                                 style="width: 32px; height: 32px; font-size: 14px;">
                                ${pilot.driver_name.split(' ').map(n => n[0]).join('')}
                            </div>
                            <div>
                                <strong>${pilot.driver_name}</strong>
                                ${teamBadge}
                            </div>
                        </div>
                    </td>
                    <td class="text-center">
                        <small class="text-muted">${pilot.team_name}</small>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-primary">${pilot.best_lap.toFixed(3)}s</span>
                        <br>
                        <small class="text-muted">
                            <span class="badge bg-${getTyreColor(pilot.initial_tyre)}">${getTyreName(pilot.initial_tyre)}</span>
                        </small>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-secondary">${pilot.total_laps}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-info">${pilot.tests_count}</span>
                    </td>
                </tr>
            `;
        });

        leaderboardBody.innerHTML = leaderboardHTML;
    } catch (error) {
        console.error('Error cargando leaderboard:', error);
        leaderboardBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error cargando datos</td></tr>';
    }
}

// FUNCI√ìN PARA CARGAR TESTS DEL EQUIPO
async function loadMyTeamTests(page = 1) {
    const testHistory = document.getElementById('testHistory');

    try {
        const response = await fetch(`/api/tests/my_team?page=${page}`);
        const data = await response.json();

        if (data.tests.length === 0) {
            testHistory.innerHTML = '<p class="text-muted text-center p-3">No hay tests en el historial</p>';
            return;
        }

        let historyHTML = data.tests.map(test => `
            <div class="test-history-item border-bottom p-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong class="d-block">${test.driver_name}</strong>
                        <small class="text-muted">${test.circuit_name}</small>
                    </div>
                    <div class="text-end">
                        <strong class="text-success d-block">${test.best_lap.toFixed(3)}s</strong>
                        <small class="text-muted">${test.total_laps} vueltas</small>
                    </div>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-1">
                    <span class="badge bg-${getTyreColor(test.initial_tyre)}">${getTyreName(test.initial_tyre)}</span>
                    <div>
                        <span class="badge bg-${test.incidents > 0 ? 'danger' : 'success'} me-1">${test.incidents} inc.</span>
                        <small class="text-muted">${test.created_at}</small>
                    </div>
                </div>
                <div class="mt-1">
                    <small class="text-muted">
                        Promedio: ${test.avg_lap.toFixed(3)}s ‚Ä¢ Paradas: ${test.pit_stops} ‚Ä¢ Condici√≥n: ${getConditionName(test.track_condition)}
                    </small>
                </div>
                <div class="mt-1 text-end">
                    <small class="text-muted test-auto-cleanup-notice">Se eliminar√° autom√°ticamente despu√©s de la carrera</small>
                </div>
            </div>
        `).join('');

        // A√±adir paginaci√≥n si es necesario
        if (data.total_pages > 1) {
            historyHTML += `
                <div class="pagination-container mt-3 text-center">
                    <small class="text-muted">
                        P√°gina ${data.current_page} de ${data.total_pages}
                    </small>
                    <div class="btn-group btn-group-sm mt-1">
                        ${data.has_prev ? `<button class="btn btn-outline-primary" onclick="loadMyTeamTests(${data.current_page - 1})">Anterior</button>` : ''}
                        ${data.has_next ? `<button class="btn btn-outline-primary" onclick="loadMyTeamTests(${data.current_page + 1})">Siguiente</button>` : ''}
                    </div>
                </div>
            `;
        }

        testHistory.innerHTML = historyHTML;
    } catch (error) {
        console.error('Error cargando tests del equipo:', error);
        testHistory.innerHTML = '<p class="text-center text-danger">Error cargando historial</p>';
    }
}

// FUNCI√ìN PARA SCROLL AL FORMULARIO DE TEST
function scrollToTestForm() {
    document.getElementById('testConfigForm').scrollIntoView({ 
        behavior: 'smooth',
        block: 'center'
    });
}

// FUNCI√ìN PARA MOSTRAR GR√ÅFICO DE DESGASTE
function showWearChart() {
    alert('Funci√≥n de gr√°fico de desgaste - Por implementar');
}

// FUNCI√ìN PARA MOSTRAR RESULTADO DE VUELTA - CORREGIDA
function displayLapResult(lap, lapResult, currentTyre, trackCondition) {
    const lapResults = document.getElementById('lapResults');
    const lapElement = document.createElement('div');
    
    let lapClass = 'lap-result border-bottom p-2';
    let incidentBadge = '';
    let pitStopBadge = '';
    let conditionBadge = '';
    let temperatureBadge = '';
    let fastLapsBadge = '';
    
    // COLORES POR DESGASTE M√ÅS SIGNIFICATIVOS
    if (lapResult.tyreWear > 80) {
        lapClass += ' bg-danger text-white';
    } else if (lapResult.tyreWear > 60) {
        lapClass += ' bg-warning';
    } else if (lapResult.tyreWear > 40) {
        lapClass += ' bg-info text-dark';
    } else if (lapResult.tyreCondition === 'cold') {
        lapClass += ' bg-primary text-white';
    } else if (lapResult.tyreCondition === 'overheating') {
        lapClass += ' bg-dark text-white';
    }
    
    if (lapResult.incident) {
        const incidentColor = lapResult.incident.severity === 'high' ? 'danger' : 
                            lapResult.incident.severity === 'medium' ? 'warning' : 'secondary';
        incidentBadge = `<span class="badge bg-${incidentColor} ms-2">${lapResult.incident.type} +${lapResult.timeLost.toFixed(1)}s</span>`;
    }
    
    if (lapResult.pitStop) {
        pitStopBadge = `<span class="badge bg-success ms-2">BOXES (${getTyreName(currentTyre)})</span>`;
    }

    conditionBadge = `<span class="badge bg-${getConditionColor(trackCondition)} me-2">${getConditionName(trackCondition)}</span>`;
    
    const tempColor = getTemperatureColor(lapResult.tyreTemperature, lapResult.tyreCondition);
    temperatureBadge = `<span class="badge bg-${tempColor} me-2">${lapResult.tyreCondition === 'cold' ? '‚ùÑÔ∏è' : lapResult.tyreCondition === 'overheating' ? 'üî•' : 'üå°Ô∏è'} ${lapResult.tyreCondition}</span>`;
    
    // Mostrar badge solo desde 3 vueltas r√°pidas
    if (lapResult.consecutiveFastLaps >= 3) {
        fastLapsBadge = `<span class="badge bg-warning me-2">üöÄ ${lapResult.consecutiveFastLaps} vueltas r√°pidas</span>`;
    }
    
    lapElement.className = lapClass;
    lapElement.innerHTML = `
        ${conditionBadge}
        ${temperatureBadge}
        ${fastLapsBadge}
        <strong>Vuelta ${lap}:</strong> 
        ${lapResult.lapTime.toFixed(3)}s - 
        <span class="badge bg-${getTyreColor(currentTyre)}">${getTyreName(currentTyre)}</span>
        - Desgaste: ${Math.round(lapResult.tyreWear)}%
        ${incidentBadge}
        ${pitStopBadge}
        <small class="text-muted ms-2">Var: ${lapResult.consistencyVariation.toFixed(3)}</small>
    `;
    lapResults.appendChild(lapElement);
    lapResults.scrollTop = lapResults.scrollHeight;
}

// FUNCI√ìN PRINCIPAL DE SIMULACI√ìN DE TEST
function simulateTestSession(driver, car, initialTyre, trackCondition, totalLaps) {
    const lapResults = document.getElementById('lapResults');
    const progressBar = document.getElementById('testProgressBar');
    lapResults.innerHTML = '';
    
    let lapTimes = [];
    let wearData = [];
    let incidents = 0;
    let totalTimeLost = 0;
    let pitStops = 0;
    
    let currentTyre = initialTyre;
    let previousData = {};

    console.log(`Simulando ${totalLaps} vueltas para ${driver.name} con neum√°ticos ${initialTyre}`);

    // Simular vuelta por vuelta usando el motor
    for (let lap = 1; lap <= totalLaps; lap++) {
        setTimeout(() => {
            // Usar el motor de simulaci√≥n para cada vuelta
            const lapResult = raceEngine.simulateLap(
                driver, 
                car, 
                currentTyre, 
                trackCondition, 
                lap, 
                { ...previousData, incidents },
				true
            );

            // Actualizar datos para siguiente vuelta
            previousData = {
                tyreWear: lapResult.tyreWear,
                tyreTemperature: lapResult.tyreTemperature,
                tyreCondition: lapResult.tyreCondition,
                consecutiveFastLaps: lapResult.consecutiveFastLaps,
                lastLapTime: lapResult.lapTime,
                incidents: incidents,
                pitStop: lapResult.pitStop
            };

            // Manejar cambio de neum√°ticos si es necesario
            if (lapResult.pitStop) {
                currentTyre = raceEngine.getAppropriateTyre(trackCondition);
                pitStops++;
                console.log(`Parada en boxes - Nuevos neum√°ticos: ${currentTyre}`);
            }

            // Acumular estad√≠sticas
            lapTimes.push(lapResult.lapTime);
            if (lapResult.incident) {
                incidents++;
                totalTimeLost += lapResult.timeLost;
            }

            wearData.push({
                lap: lap,
                lap_time: lapResult.lapTime,
                tyre_wear: Math.round(lapResult.tyreWear),
                tyre: currentTyre,
                temperature: Math.round(lapResult.tyreTemperature),
                condition: lapResult.tyreCondition,
                incident: lapResult.incident,
                time_lost: lapResult.timeLost,
                pit_stop: lapResult.pitStop,
                track_condition: trackCondition,
                consistency_variation: lapResult.consistencyVariation.toFixed(3),
                fast_laps: lapResult.consecutiveFastLaps
            });

            // Mostrar resultado de la vuelta
            displayLapResult(lap, lapResult, currentTyre, trackCondition);
            
            // Actualizar progreso
            const progress = (lap / totalLaps) * 100;
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${Math.round(progress)}%`;
            
            // Mostrar resumen al finalizar
            if (lap === totalLaps) {
                const testSummary = {
                    driverId: driver.id,
                    driverName: driver.name,
                    initialTyre: initialTyre,
                    totalLaps: totalLaps,
                    incidents: incidents,
                    totalTimeLost: totalTimeLost,
                    pitStops: pitStops,
                    trackCondition: trackCondition,
                    lapTimes: lapTimes,
                    wearData: wearData,
                    timestamp: new Date().toISOString()
                };
                
                console.log("Test completado, guardando en base de datos...", testSummary);
                showTestSummary(testSummary);
                document.getElementById('startTestBtn').disabled = false;
            }
        }, lap * 150);
    }
}

// INICIALIZACI√ìN
document.addEventListener('DOMContentLoaded', function() {
    console.log("P√°gina de tests cargada");
    
    // Mostrar historial y clasificaci√≥n al cargar
    loadMyTeamTests();
    loadTestLeaderboard();
    updateTestCounter(); // Mostrar contador de tests

    // Iniciar test usando el motor de simulaci√≥n
    document.getElementById('testConfigForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Verificar l√≠mite antes de iniciar
        const limitCheck = await checkTestLimit();
        if (!limitCheck.allowed) {
            alert(limitCheck.message);
            return;
        }
        
        const driverSelect = document.getElementById('driverSelect');
        const selectedOption = driverSelect.options[driverSelect.selectedIndex];
        const driver = {
            id: driverSelect.value,
            name: normalizeDriverName(selectedOption.textContent.split(' (')[0]),
            skill: parseInt(selectedOption.getAttribute('data-skill')),
            consistency: parseInt(selectedOption.getAttribute('data-consistency'))
        };
        
        const tyreType = document.getElementById('tyreSelect').value;
        const totalLaps = parseInt(document.getElementById('totalLaps').value);
        
        {% set test_weather = weather_forecasts|selectattr("session_type", "equalto", "test")|first %}
        const trackCondition = "{{ test_weather.condition if test_weather else 'dry' }}";
        
        if (!driver.id) {
            alert('Selecciona un piloto');
            return;
        }

        // Configurar coche del equipo
        const car = [
            {% for component in team.car_components %}
            { 
                type: "{{ component.component_type }}", 
                strength: {{ component.strength }},
                reliability: {{ component.reliability }}
            },
            {% endfor %}
        ];

        console.log("Iniciando test para:", driver.name, "con neum√°ticos:", tyreType);

        // Mostrar secci√≥n de resultados
        document.getElementById('testResults').style.display = 'block';
        document.getElementById('startTestBtn').disabled = true;

        // Simular test usando el motor
        simulateTestSession(driver, car, tyreType, trackCondition, totalLaps);
    });

    // EVENT LISTENERS
    document.getElementById('refreshLeaderboardBtn').addEventListener('click', function() {
        loadTestLeaderboard();
        updateTestCounter(); // Actualizar contador al refrescar
    });
    
    document.getElementById('clearHistoryBtn').addEventListener('click', showTestLimitsInfo);
    
    // Filtro de historial (para futura implementaci√≥n)
    document.getElementById('historyFilter').addEventListener('change', function() {
        // Por ahora recargamos todos los tests, pero se podr√≠a filtrar en el futuro
        loadMyTeamTests();
    });
});

</script>

<style>
.lap-result {
    transition: all 0.3s ease;
}
.lap-result:hover {
    background-color: #f8f9fa !important;
}
.tyre-info {
    background-color: #f8f9fa;
}
.test-history-item:hover {
    background-color: #f8f9fa;
}
.progress-bar {
    transition: width 0.3s ease;
}
.driver-avatar {
    font-weight: bold;
    text-transform: uppercase;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.table-hover tbody tr:hover {
    transform: translateY(-1px);
    transition: all 0.2s ease;
}
.pagination-container {
    border-top: 1px solid #dee2e6;
    padding-top: 10px;
}
.test-limit-warning {
    border-left: 4px solid #dc3545;
    background-color: #f8d7da;
}
.test-limit-info {
    border-left: 4px solid #0dcaf0;
}
.test-auto-cleanup-notice {
    font-size: 0.875rem;
    color: #6c757d;
    font-style: italic;
}
/* Responsive */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    .driver-avatar {
        width: 28px !important;
        height: 28px !important;
        font-size: 12px !important;
    }
    .test-history-item {
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}